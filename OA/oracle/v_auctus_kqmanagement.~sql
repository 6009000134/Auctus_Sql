create or replace view v_auctus_kqmanagement as
with UserGroup as--人员考勤组
(
select a.id,a.groupname,b.type,b.typevalue,c.id userid,c.lastname from kq_group a inner join kq_groupmember b on a.id=b.groupid
inner join hrmresource c on b.type=1 and b.typevalue=c.id
where nvl(a.isdelete,0)!=1
and c.status in (0,1,2,3)
union all
select a.id,a.groupname,b.type,b.typevalue,d.id userid,d.lastname
from kq_group a inner join kq_groupmember b on a.id=b.groupid
inner join hrmsubcompany c on b.type=2 and b.typevalue=c.id
left join hrmresource d on d.subcompanyid1=c.id
where nvl(a.isdelete,0)!=1
and nvl(b.isdelete,0)!=1
and d.status in (0,1,2,3)
)
select * from (
--考勤组与上下班关系
select a.groupname,a.userid,a.lastname,b.*,c.serial,d.times starttime,d1.times EndTime
,e.seriouslateminutes
,row_number() over(partition by a.userid,b.weekday order by d.times)rn
from UserGroup a
left join kq_fixedschedulce b on a.id=b.groupid
left join kq_ShiftManagement c on b.serialid=c.id
left join KQ_SHIFTONOFFWORKSECTIONS d on c.id=d.serialid and d.onoffworktype='start'
left join KQ_SHIFTONOFFWORKSECTIONS d1 on c.id=d1.serialid and d1.onoffworktype='end'
left join kq_ShiftPersonalizedRule e on c.id=e.serialid
where 1=1
--and a.lastname='邓细芬'
--and a.groupname='卫生阿姨'
) t where t.rn=1;
